<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light p-4">

  <div class="mb-3">
    <label class="form-label fw-bold text-primary">1. Folio / ID de Atención:</label>
    <input type="text" id="txtIdAtencion" class="form-control" placeholder="Ej: abc12345">
    <div class="form-text small">Cópielo desde el documento físico o la planilla.</div>
  </div>

  <div class="mb-4">
    <label class="form-label fw-bold text-primary">2. Documento Firmado:</label>
    <input type="file" id="fileDoc" class="form-control" accept=".pdf,image/*">
  </div>

  <button id="btnSubir" class="btn btn-primary w-100 fw-bold" onclick="subir()">
    ⬆️ Subir y Guardar
  </button>
  
  <div id="mensaje" class="mt-3"></div>

  <script>
    function subir() {
      const idAtencion = document.getElementById('txtIdAtencion').value.trim();
      const fileInput = document.getElementById('fileDoc');
      
      if (!idAtencion) return mostrarAlerta("Ingrese el Folio de Atención", "danger");
      if (fileInput.files.length === 0) return mostrarAlerta("Seleccione un archivo", "danger");

      const btn = document.getElementById('btnSubir');
      btn.disabled = true;
      btn.innerText = "⏳ Subiendo archivo (Puede tardar unos segundos)...";
      document.getElementById('mensaje').innerHTML = "";

      const file = fileInput.files[0];
      const reader = new FileReader();

      // Cuando termina de leer el archivo en la computadora, lo envía a Google
      reader.onload = function(e) {
        const datos = {
          idAtencion: idAtencion,
          archivoNombre: file.name,
          archivoData: e.target.result // Esto es el archivo convertido a texto Base64
        };

        google.script.run
          .withSuccessHandler(res => {
            btn.disabled = false;
            btn.innerText = "⬆️ Subir y Guardar";
            if (res.success) {
              mostrarAlerta("✅ " + res.mensaje, "success");
              document.getElementById('txtIdAtencion').value = ""; // Limpiar
              fileInput.value = ""; // Limpiar
            } else {
              mostrarAlerta("❌ " + res.mensaje, "danger");
            }
          })
          .withFailureHandler(err => {
            btn.disabled = false;
            btn.innerText = "⬆️ Subir y Guardar";
            mostrarAlerta("Error de conexión: " + err.message, "danger");
          })
          .procesarSubidaDocumento(datos);
      };

      // Inicia la lectura del archivo
      reader.readAsDataURL(file);
    }

    function mostrarAlerta(texto, tipo) {
      const div = document.getElementById('mensaje');
      div.innerHTML = `<div class="alert alert-${tipo} p-2 small fw-bold">${texto}</div>`;
    }
  </script>
</body>
</html>
